name: Backport to Develop

on:
  pull_request:
    types:
      - closed
    branches:
      - 4.13.*

jobs:
  backport:
    name: Backport to develop
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Check for backport labels
        id: check-backport
        run: |
          LABEL_BACKPORT="backport-to-develop"
          LABEL_DO_NOT_BACKPORT="do-not-backport"
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "$LABEL_BACKPORT" || echo "$LABELS" | grep -q "$LABEL_DO_NOT_BACKPORT"; then
              echo "PR with valid backport label:"
          fi
          if echo "$LABELS" | grep -q "$LABEL_BACKPORT"; then
            echo "backport_status=continue" >> $GITHUB_OUTPUT
            echo "${LABEL_BACKPORT}"
          else
            echo "backport_status=abort" >> $GITHUB_OUTPUT
            echo "${LABEL_DO_NOT_BACKPORT}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract PR branch name
        if: steps.check-backport.outputs.backport_status == 'continue'
        id: extract-branch
        run: |
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "pr_branch=${PR_BRANCH}" >> $GITHUB_OUTPUT
          echo "PR branch is ${PR_BRANCH}"

      - name: Create backport PR into develop
        if: steps.check-backport.outputs.backport_status == 'continue'
        id: backport-pr
        run: |
          echo "status=fail" >> $GITHUB_OUTPUT
          PR_BRANCH_NAME="${{ steps.extract-branch.outputs.pr_branch }}"
          BACKPORT_BRANCH="backport/$PR_BRANCH_NAME"

          echo  ${{ github.event.pull_request.commits.last.sha }}
          
          git checkout -b ${BACKPORT_BRANCH} ${{ github.event.pull_request.commits.last.sha }}
          # COMMITS=$(git log --no-merges --pretty=format:"%H" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          COMMITS=${{ github.event.pull_request.commits }}
          for commit in $COMMITS; do
            echo "Cherry-picking commit: $commit"
          done

          git push origin ${BACKPORT_BRANCH}
          echo "Created backport branch: ${BACKPORT_BRANCH}"

          # Create PR using GitHub CLI
          gh pr create \
            --base develop \
            --head ${BACKPORT_BRANCH} \
            --assignee "${{ github.event.pull_request.user.login }}" \
            --title "Backport: ${{ github.event.pull_request.title }}" \
            --body "This PR backports changes from ${{ steps.extract-branch.outputs.pr_branch }} that were merged into ${{ github.event.pull_request.base.ref }} via #${{ github.event.pull_request.number }}."
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "Backport PR created successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle backport PR creation failure
        if: steps.backport-pr.outputs.status == 'fail'
        run: |
          # Create issue about the conflict
          gh issue create \
            --assignee "${{ github.event.pull_request.user.login }}" \
            --title "Fail to backport ${{ steps.extract-branch.outputs.pr_branch }} to develop" \
            --body "There was failure when trying to backport changes from PR #${{ github.event.pull_request.number }} to develop branch. Manual backport changes into develop branch is required."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
